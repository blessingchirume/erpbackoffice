name: Deploy Laravel App

on:
  push:
    branches: [ main ]

env:
  DOCKER_COMPOSE_VERSION: 1.29.2

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install SSH key
      uses: shimataro/ssh-key-action@v2
      with:
#        key: ${{ secrets.SSH_PRIVATE_KEY }}
        known_hosts: 'just-a-placeholder-so-we-dont-get-errors'

    - name: Copy files via SSH
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
#        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: ".github,docker,app,artisan,bootstrap,config,database,public,resources,routes,storage,tests,vendor,composer.json,composer.lock,package.json,Dockerfile,docker-compose.yml,.env.example"
        target: "/var/www/laravel-app"

    - name: Run deployment commands
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
#        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /var/www/laravel-app
          cp .env.example .env
          docker-compose down
          docker-compose build --no-cache
          docker-compose up -d
          docker-compose exec -T app composer install --no-dev
          docker-compose exec -T app php artisan key:generate
          docker-compose exec -T app php artisan migrate --force
          docker-compose exec -T app php artisan storage:link
          docker-compose exec -T app chown -R www-data:www-data /var/www/storage
          docker-compose exec -T app chmod -R 775 /var/www/storage
